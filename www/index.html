<html>

<head>
	<title>Test Game</title>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
	<link rel="stylesheet" href="main.css" type="text/css"/>
	<script type="text/javascript" src="misc.js"></script>
	<script type="text/javascript" src="sha256.js"></script>
	<script type="text/javascript" src="session.js"></script>
	<script type="text/javascript" src="game.js"></script>
	<script type="text/javascript" src="map.js"></script>
</head>

<body onUnload="javascript:Session.logout();" onLoad="javascript:set_logged_in();">

<script type="text/javascript">

set_error = function(msg)
{
	//Scrub message
	msg = msg.replace(/\&/g, "&amp;")
			 .replace(/\</g, "&lt;")
			 .replace(/\>/g, "&gt;")
			 .replace(/\n/g, "\<br\/\>");

	if(!Session.logged_in)
	{
		document.getElementById('errMsg').innerHTML = msg;
	}
	else
	{
		var appElem = document.getElementById('appElem');
		appElem.style.display = 'none';
		var noGL = document.getElementById('noWebGL');
		var noGLerr = document.getElementById('noWebGLReason');
		noGL.style.display = 'block';
		noGLerr.innerHTML = msg;
	}
}

set_logged_in = function()
{
	var loginElem = document.getElementById('loginElem');
	var appElem = document.getElementById('appElem');
	
	loginElem.style.display = 'none';
	appElem.style.display   = 'block';
	
	var res = Game.init(document.getElementById('canvas'));
	if(res != 'Ok')
	{
		set_error(res);
	}
	else
	{
		Game.draw();
	}
}

do_register = function()
{
	var user_txt = document.getElementById('userName');
	var pass_txt = document.getElementById('password');
	
	var res = Session.register(user_txt.value, pass_txt.value);
	pass_txt.value = "";
	
	if(res == 'ok')
	{	set_logged_in();
	}
	else
	{	set_error(res);
	}
}

do_login = function()
{
	var user_txt = document.getElementById('userName');
	var pass_txt = document.getElementById('password');
	
	var res = Session.login(user_txt.value, pass_txt.value);
	pass_txt.value = "";
	
	if(res == 'ok')
	{	set_logged_in();
	}
	else
	{	set_error(res);
	}
}
</script>


<div id="loginElem" align=center>
<input type="text" id="userName" width="20" value=""/> <br/>
<input type="password" id="password" width="20" value="" /> <br/>

<input type="button" value="Login" onclick="javascript:do_login();">
<input type="button" value="Create Account" onclick="javascript:do_register();">

<div id="errMsg" style="color:red;"> </div>
</div>

<div id="appElem" style="display:none;">
<canvas id="canvas" width=500 height=500></canvas><br/>
</div>

<div id="noWebGL" style="display:none; background-color:red; color:black;">
<h1> <tt> !!!ABORT!!! <br/>
REASON: <div id="noWebGLReason"></div> </tt> </h1>
</div>

</body>
</html>
